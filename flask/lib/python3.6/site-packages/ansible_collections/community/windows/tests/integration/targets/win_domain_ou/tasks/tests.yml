---
- name: Ensure OU is present
  community.windows.win_domain_ou:
    name: AnsibleFest
  register: test1
  failed_when: test1 is not changed

- name: Ensure OU is present (idempotence check)
  community.windows.win_domain_ou:
    name: AnsibleFest
  register: test1a
  failed_when: test1a is changed

- name: Ensure OU is absent
  community.windows.win_domain_ou:
    name: AnsibleFest
    state: absent
  register: test1_clean
  failed_when: test1_clean is not changed

- name: Ensure OU is absent (idempotence check)
  community.windows.win_domain_ou:
    name: AnsibleFest
    state: absent
  register: test1_clean_idempotent
  failed_when: test1_clean_idempotent is changed

- name: Ensure OU is present with path
  community.windows.win_domain_ou:
    name: End User Computing
    path: "{{ win_domain_ou_root_path }}"
  register: test2
  failed_when: test2 is not changed

- name: Ensure OU is present with path (idempotence check)
  community.windows.win_domain_ou:
    name: End User Computing
    path: "{{ win_domain_ou_root_path }}"
  register: test2a
  failed_when: test2a is changed

- name: Ensure OU has updated properties
  community.windows.win_domain_ou:
    name: End User Computing
    protected: true
    path: "{{ win_domain_ou_root_path }}"
    properties:
      city: Sandy Springs
      state: Georgia
      streetaddress: 1155 Perimeter Center West
      country: US
      description: EUC Business Unit
      postalcode: 30189
  register: test3
  failed_when: test3 is not changed

- name: Ensure OU has updated properties (idempotence check)
  community.windows.win_domain_ou:
    name: End User Computing
    protected: true
    path: "{{ win_domain_ou_root_path }}"
    properties:
      city: Sandy Springs
      state: Georgia
      streetaddress: 1155 Perimeter Center West
      country: US
      description: EUC Business Unit
      postalcode: 30189
  register: test3a
  failed_when: test3a is changed

- name: Ensure OU structure is present
  community.windows.win_domain_ou:
    name: "{{ item.name }}"
    protected: false
    path: "{{ item.path }}"
  loop: "{{ win_domain_ou_structure }}"
  register: test4
  failed_when: test4 is not changed

- name: Ensure OU structure is present (idempotence check)
  community.windows.win_domain_ou:
    name: "{{ item.name }}"
    protected: false
    path: "{{ item.path }}"
  loop: "{{ win_domain_ou_structure }}"
  register: test4a
  failed_when: test4a is changed

- name: Ensure OU structure is absent, recursive
  community.windows.win_domain_ou:
    name: VMware
    path: "{{ win_domain_ou_root_path }}"
    state: absent
    recursive: true
  register: test5
  failed_when: test5 is not changed

- name: Ensure OU structure is absent, recursive (idempotence check)
  community.windows.win_domain_ou:
    name: VMware
    path: "{{ win_domain_ou_root_path }}"
    state: absent
    recursive: true
  register: test5a
  failed_when: test5a is changed

- name: Ensure OU is present with specific properties
  community.windows.win_domain_ou:
    name: VMW Atlanta
    path: "{{ win_domain_ou_root_path }}"
    properties:
      city: Sandy Springs
      state: Georgia
      streetaddress: 1155 Perimeter Center West
  register: test6
  failed_when: test6 is not changed

- name: Ensure OU is present with specific properties (idempotence check)
  community.windows.win_domain_ou:
    name: VMW Atlanta
    path: "{{ win_domain_ou_root_path }}"
    properties:
      city: Sandy Springs
      state: Georgia
      streetaddress: 1155 Perimeter Center West
  register: test6a
  failed_when: test6a is changed

- name: Ensure OU is present with specific properties added
  community.windows.win_domain_ou:
    name: VMW Atlanta
    path: "{{ win_domain_ou_root_path }}"
    properties:
      country: US
      description: EUC Business Unit
      postalcode: 30189
  register: test7
  failed_when: test7 is not changed

- name: Ensure OU is present with specific properties added (idempotence check)
  community.windows.win_domain_ou:
    name: VMW Atlanta
    path: "{{ win_domain_ou_root_path }}"
    properties:
      country: US
      description: EUC Business Unit
      postalcode: 30189
  register: test7a
  failed_when: test7a is changed

- name: Ensure OU is absent
  community.windows.win_domain_ou:
    name: End User Computing
    path: "{{ win_domain_ou_root_path }}"
    state: absent
  register: test8
  failed_when: test8 is not changed

- name: Ensure OU is absent (idempotence check)
  community.windows.win_domain_ou:
    name: End User Computing
    path: "{{ win_domain_ou_root_path }}"
    state: absent
  register: test8a
  failed_when: test8a is changed

- name: Ensure OU is absent
  community.windows.win_domain_ou:
    name: VMW Atlanta
    path: "{{ win_domain_ou_root_path }}"
    state: absent
  register: test9
  failed_when: test9 is not changed

- name: Ensure OU is absent (idempotence check)
  community.windows.win_domain_ou:
    name: VMW Atlanta
    path: "{{ win_domain_ou_root_path }}"
    state: absent
  register: test9a
  failed_when: test9a is changed

- name: Assertions
  assert:
    that:
      - test1a.ou.Name == "AnsibleFest"
      - test3a.ou.StreetAddress == "1155 Perimeter Center West"
      - test7a.ou.Country == "US"
      - test6a.ou.City == "Sandy Springs"
