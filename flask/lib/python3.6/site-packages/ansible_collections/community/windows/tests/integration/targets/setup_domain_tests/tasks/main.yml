---
- name: Change the hostname to ansible-tester
  ansible.windows.win_hostname:
    name: ansible-tester
  register: rename_host

- name: Reboot
  ansible.windows.win_reboot:
  when: rename_host.reboot_required

- name: Ensure AD/DNS roles are installed
  ansible.windows.win_feature:
    name:
      - AD-Domain-Services
      - DNS
    include_management_tools: true
    include_sub_features: true
    state: present

- name: Ensure domain is present
  ansible.windows.win_domain:
    dns_domain_name: ansible.test
    safe_mode_password: password123!
  register: ensure_domain

- name: Reboot
  ansible.windows.win_reboot:
  when: ensure_domain.changed

- name: Try Import-Module
  ansible.windows.win_shell: |
    whoami
    try{Import-Module ActiveDirectory}
    catch{
      start-sleep -seconds 10
      Import-Module ActiveDirectory
    }
  ignore_errors: true
  register: import_test

- name: Reboot Again
  ansible.windows.win_reboot:
  when: import_test is failed

- name: Wait for ADWS
  community.windows.win_wait_for_process:
    process_name_exact: Microsoft.ActiveDirectory.WebServices
    timeout: 120
    sleep: 5
    process_min_count: 1

- name: Try Import Again
  block:
    - name: Try Import-Module
      ansible.windows.win_shell: |
        whoami
        try{Import-Module ActiveDirectory}
        catch{
          start-sleep -seconds 5
          Import-Module ActiveDirectory
        }
      register: import_test2
  rescue:
    - name: Try Import-Module
      ansible.windows.win_shell: C:\Windows\system32\WindowsPowerShell\v1.0\Modules\ActiveDirectory\ActiveDirectory.psd1
      register: import_test3

- name: Wait for ADWS
  community.windows.win_wait_for_process:
    process_name_exact: Microsoft.ActiveDirectory.WebServices
    timeout: 120
    sleep: 5
    process_min_count: 1

- name: Try Import Again
  block:
    - name: Try Import-Module
      ansible.windows.win_shell: |
        whoami
        try{Import-Module ActiveDirectory}
        catch{
          start-sleep -seconds 5
          Import-Module ActiveDirectory
        }
      register: import_test2
  rescue:
    - name: Try Import-Module
      ansible.windows.win_shell: C:\Windows\system32\WindowsPowerShell\v1.0\Modules\ActiveDirectory\ActiveDirectory.psd1
      register: import_test3
